name: Agentic Audit (Requirements Status)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - "scripts/**"
      - "Requirements/**"
      - "Agentic AI Work/**"
      - "package.json"
      - "pnpm-lock.yaml"
      - ".github/workflows/**"

jobs:
  audit:
    runs-on: windows-latest

    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js (Node.js)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Enable Corepack (Corepack) + pnpm (performant Node Package Manager)
        shell: pwsh
        run: |
          corepack enable
          pnpm --version

      - name: Setup Python (Python)
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Python deps (OpenAI SDK)
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip install openai

      - name: Run audit (pnpm + agentic scan)
        shell: pwsh
        run: |
          pwsh -NoProfile -ExecutionPolicy Bypass -File .\scripts\run_audit.ps1
          
      - name: Add summary (requirements_status.md header)
        if: always()
        shell: pwsh
        run: |
          "## Agentic Audit Summary" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          if (Test-Path .\AgentOutput\requirements_status.md) {
            "### requirements_status.md (first 25 lines)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
            "```" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
            Get-Content -Encoding UTF8 .\AgentOutput\requirements_status.md -TotalCount 25 | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
            "```" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          } else {
            "No AgentOutput/requirements_status.md produced." | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          }
          if (Test-Path .\Artifacts\audit_log.txt) {
            "### audit_log.txt (last 80 lines)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
            "```" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
            Get-Content -Encoding UTF8 .\Artifacts\audit_log.txt -Tail 80 | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
            "```" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          }

      - name: Upload artifacts (AgentOutput + audit log)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agentic-audit-output
          path: |
            AgentOutput/**
            Artifacts/audit_log.txt
            Agentic AI Work/AgentOutput/**
